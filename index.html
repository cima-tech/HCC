<!DOCTYPE html>
<html lang="es">
<head>
  <!-- [SEC-001] METADATOS BÁSICOS -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HCC - Sistema de Médicos</title>

  <!-- [SEC-002] BASE DE DATOS (JSON JS EXTERNO) -->
  <script src="HCC_data.js"></script>

  <!-- [SEC-003] ESTILOS GLOBALES Y LAYOUT -->
  <style>
    :root {
      --color-base: #1c4e80;
      --color-secundario: #f0f4fb;
      --color-borde: #d0d7e2;
      --color-texto: #222;
      --radius: 8px;
      --shadow-soft: 0 2px 6px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      font-size: 12px;
      margin: 0;
      padding: 16px;
      background: #f5f7fb;
      color: var(--color-texto);
    }

    /* [SEC-010] LOGIN / LOCK SCREEN */
    .lock-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #2f6fb8, #0c1b2e);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .lock-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 18px 20px 16px 20px;
      width: 90%;
      max-width: 360px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      text-align: center;
    }
    .lock-card h2 {
      margin: 0 0 4px 0;
      font-size: 18px;
      color: var(--color-base);
    }
    .lock-subtitle {
      font-size: 11px;
      color: #555;
      margin-bottom: 14px;
    }
    .lock-input {
      width: 100%;
      padding: 8px 10px;
      font-size: 16px;          /* >=16px para que iOS no haga zoom automático */
      border-radius: 8px;
      border: 1px solid #ccd3e2;
      margin-bottom: 10px;
    }
    .lock-input:focus {
      outline: none;
      border-color: var(--color-base);
      box-shadow: 0 0 0 1px rgba(28,78,128,0.18);
    }
    .lock-btn {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid var(--color-base);
      background: var(--color-base);
      color: #fff;
      cursor: pointer;
    }
    .lock-btn:hover {
      background: #163d62;
    }
    .lock-error {
      font-size: 11px;
      color: #e74c3c;
      min-height: 14px;
      margin-top: 6px;
    }

    /* [SEC-020] LAYOUT GENERAL APP */
    #app {
      display: none; /* se muestra al pasar el login */
    }

    .main-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      background: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: var(--shadow-soft);
      max-width: 980px;
      margin-left: auto;
      margin-right: auto;
    }

    .main-header-logo svg {
      height: 40px;
      width: auto;
      display: block;
    }

    .main-header-titles h1 {
      margin: 0;
      font-size: 18px;
      color: var(--color-base);
    }

    .main-header-titles .subtitulo {
      margin: 2px 0 0 0;
      font-size: 11px;
      color: #555;
    }

    .top-actions {
      display: flex;
      justify-content: flex-end;
      margin: 8px auto;
      max-width: 980px;
    }

    .btn-export {
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid var(--color-base);
      background: var(--color-base);
      color: #fff;
      cursor: pointer;
    }

    .btn-export:hover { background: #163d62; }

    .layout-top {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 0 auto 6px auto;
      max-width: 980px;
    }

    .panel {
      background: #fff;
      border-radius: var(--radius);
      border: 1px solid var(--color-borde);
      box-shadow: var(--shadow-soft);
    }

    .panel-title {
      padding: 6px 10px;
      border-bottom: 1px solid var(--color-borde);
      font-weight: bold;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #555;
    }

    .panel-body { padding: 8px 10px 10px 10px; }

    #controles_columnas {
      min-width: 220px;
      max-width: 260px;
      font-size: 11px;
    }

    .chk-col {
      display: inline-block;
      margin-right: 6px;
      margin-bottom: 4px;
      font-size: 10px;
      white-space: nowrap;
    }

    #filtros {
      flex: 1;
      min-width: 280px;
      font-size: 11px;
    }

    .filtros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px 10px;
      align-items: flex-start;
    }

    .filtro label {
      display: block;
      font-size: 10px;
      margin-bottom: 3px;
      color: #444;
    }

    .filtro input[type="text"],
    .filtro select {
      width: 100%;
      padding: 4px 6px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid var(--color-borde);
    }

    .filtro input[type="text"]:focus,
    .filtro select:focus {
      outline: none;
      border-color: var(--color-base);
      box-shadow: 0 0 0 1px rgba(28,78,128,0.15);
    }

    .filtro-botones { text-align: right; }

    #btn-limpiar {
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid var(--color-base);
      background: #fff;
      color: var(--color-base);
      cursor: pointer;
    }

    #btn-limpiar:hover { background: #f0f4ff; }

    .filtro-multi .filtro-title {
      font-size: 10px;
      margin-bottom: 3px;
      color: #444;
    }

    .filtro-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .chip-filter {
      font-size: 10px;
      border-radius: 12px;
      border: 1px solid var(--color-borde);
      padding: 2px 6px;
      background: #f8f9ff;
      cursor: pointer;
    }

    .chip-filter input { margin-right: 3px; }

    .section-tablas {
      margin-top: 8px;
      max-width: 980px;
      margin-left: auto;
      margin-right: auto;
    }

    h2 {
      margin-top: 16px;
      margin-bottom: 4px;
      font-size: 16px;
      color: var(--color-base);
    }

    .tabla-wrapper {
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
    }

    .tabla-wrapper-inner {
      max-width: 960px;
      margin: 0 auto;
    }

    /* [SEC-030] TABLAS PRINCIPALES (NO SELECCIONABLES, RESPONSIVE, ANCHO MÁXIMO) */
    .tabla-wrapper,
    .tabla-hcc,
    .tabla-hcc * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .tabla-hcc {
      border-collapse: collapse;
      width: 100%;
      margin-top: 4px;
      background: #fff;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      min-width: 600px;
      font-size: 10px;
      table-layout: fixed;              /* clave para que no se expanda infinito */
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .tabla-hcc thead {
      background: var(--color-base);
      color: #fff;
    }

    .tabla-hcc th,
    .tabla-hcc td {
      border: 1px solid var(--color-borde);
      padding: 3px 4px;
      font-size: 10px;
      text-align: left;
    }

    /* [SEC-031] COLUMNA NÚMERO SIEMPRE ANGOSTA */
    .tabla-hcc th.col-0,
    .tabla-hcc td.col-0 {
      width: 32px;
      max-width: 32px;
      min-width: 28px;
      text-align: center;
      white-space: nowrap;
    }

    /* Sin clamp en APELLIDOS/NOMBRES para evitar confusión visual */

    .tabla-hcc tbody tr:nth-child(odd) { background: #fafbff; }
    .tabla-hcc tbody tr:hover { background: #fff5e5; }

    .tabla-hcc a {
      color: var(--color-base);
      text-decoration: none;
    }
    .tabla-hcc a:hover { text-decoration: underline; }

    /* [SEC-040] MODALES TIPO “MÓVIL” */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      border-radius: var(--radius);
      border: 1px solid var(--color-borde);
      box-shadow: 0 8px 20px rgba(0,0,0,0.20);
      max-width: 520px;
      width: 95%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .modal-mobile { max-width: 420px; }
    .modal-wide   { max-width: 640px; }

    .modal,
    .modal * {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    .modal-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--color-borde);
      font-weight: bold;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 10px 14px 12px 14px;
      overflow-y: auto;
      background: #f7f9fc;
    }

    .modal-footer {
      padding: 8px 12px;
      border-top: 1px solid var(--color-borde);
      text-align: right;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      background: #fff;
    }

    .modal-help-text {
      font-size: 11px;
      color: #555;
      margin-top: 0;
      margin-bottom: 8px;
    }

    .modal-section-title {
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #777;
      margin: 8px 0 4px 0;
    }

    .modal-field-group {
      background: #ffffff;
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      margin-bottom: 6px;
    }

    .modal-field { margin-bottom: 6px; }
    .modal-field:last-child { margin-bottom: 0; }

    .modal-field label {
      display: block;
      font-size: 10px;
      margin-bottom: 2px;
      color: #777;
    }

    .modal-field input {
      width: 100%;
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #dde2ee;
      background: #f5f7fd;
    }

    .modal-field input:focus {
      outline: none;
      border-color: var(--color-base);
      background: #fff;
      box-shadow: 0 0 0 1px rgba(28,78,128,0.18);
    }

    .contact-links {
      margin-bottom: 6px;
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .contact-links a {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--color-base);
      color: var(--color-base);
      background: #fff;
      text-decoration: none;
      font-size: 11px;
    }

    .contact-links a:hover {
      background: var(--color-base);
      color: #fff;
    }

    /* [SEC-050] MODAL DIFUSIÓN / LISTA GRUPO */
    .bulk-fields {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .bulk-fields textarea {
      width: 100%;
      min-height: 50px;
      resize: vertical;
      font-size: 11px;
      font-family: monospace;
      border-radius: 4px;
      border: 1px solid var(--color-borde);
      padding: 4px 5px;
    }

    .bulk-field-label {
      font-size: 10px;
      margin-bottom: 2px;
      color: #444;
    }

    .bulk-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    /* [SEC-060] BOTONES GENERALES */
    .btn {
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid transparent;
      cursor: pointer;
    }

    .btn-secondary {
      border-color: #aaa;
      background: #fff;
      color: #444;
    }

    .btn-secondary:hover { background: #f0f0f0; }

    .btn-primary {
      border-color: var(--color-base);
      background: var(--color-base);
      color: #fff;
    }

    .btn-primary:hover { background: #163d62; }

    .btn-danger {
      border-color: #c0392b;
      background: #e74c3c;
      color: #fff;
    }

    .btn-danger:hover { background: #c0392b; }

    .btn-icon {
      width: 24px;
      height: 24px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    /* [SEC-070] RESUMEN */
    .summary-panel {
      margin: 6px auto 0 auto;
      font-size: 11px;
      color: #333;
      max-width: 980px;
    }

    .summary-panel a {
      color: var(--color-base);
      text-decoration: underline;
      cursor: pointer;
    }

    /* [SEC-080] RESPONSIVE */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .layout-top { flex-direction: column; }
      .section-tablas { max-width: 100%; }
      .tabla-hcc { min-width: 0; }
    }

    /* [SEC-090] MODO IMPRESIÓN / PDF */
    @media print {
      .lock-screen { display: none !important; }
      .main-header,
      .top-actions,
      .layout-top,
      .summary-panel,
      #modal-backdrop,
      #modal-bulk-backdrop,
      #modal-new-backdrop {
        display: none !important;
      }
      body {
        background: #fff;
        padding: 0;
        margin: 0;
        font-size: 9pt;
      }
      .section-tablas {
        max-width: 100%;
        margin: 0;
      }
      .tabla-hcc {
        box-shadow: none;
        min-width: 0;
        font-size: 8pt;
      }
      .tabla-hcc th,
      .tabla-hcc td {
        padding: 2px 3px;
        font-size: 8pt;
      }
    }
  </style>
</head>
<body>

  <!-- [SEC-101] LOGIN / PANTALLA DE ACCESO -->
  <div id="lock-screen" class="lock-screen">
    <div class="lock-card">
      <h2>Acceso HCC</h2>
      <div class="lock-subtitle">Ingrese la contraseña para ver el directorio.</div>
      <input
        id="pwd-input"
        class="lock-input"
        type="password"
        placeholder="Contraseña"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
      />
      <button id="btn-login" class="lock-btn">Entrar</button>
      <div id="pwd-error" class="lock-error"></div>
    </div>
  </div>

  <!-- [SEC-102] APP COMPLETA (SE VE TRAS EL LOGIN) -->
  <div id="app">
    <!-- [SEC-110] ENCABEZADO PRINCIPAL + LOGO -->
    <header class="main-header">
      <div class="main-header-logo">
        <!-- Logo HCC inline SVG -->
        <svg version="1.2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 230 100" width="230" height="100">
          <style>
            .s0 { opacity: .92;fill: #000000 }
          </style>
          <path id="Path 0" fill-rule="evenodd" class="s0" d="m16.5 16.49c-1.65 0.8-3.56 2.59-4.25 3.98-0.75 1.51-1.25 6.55-1.25 12.53 0 9.78 0.07 10.07 3 13 2.94 2.94 3.2 3 13.25 3.01 6.98 0 10.89-0.43 12.25-1.35 1.1-0.74 2.59-2.66 3.31-4.26 0.89-1.94 1.22-6.11 1-12.63-0.28-8.84-0.54-9.95-2.81-12.19-1.38-1.35-3.74-2.71-5.25-3.02l-2.75-0.56v16h-11c0-13.75-0.35-15.99-1.25-15.98-0.69 0.02-2.6 0.68-4.25 1.47zm191.5 18.01v6.5c8.53 0 11-0.45 11-1 0-0.55-1.8-1-4-1-3.33 0-4-0.33-4-2 0-1.62 0.67-2 3.5-2 1.93 0 3.5-0.45 3.5-1 0-0.55-1.57-1-3.5-1-2.44 0-3.5-0.45-3.5-1.5 0-1.08 1.11-1.5 4-1.5 2.2 0 4-0.45 4-1 0-0.55-2.47-1-5.5-1h-5.5zm-194 20.42c-2.73 2.81-2.85 3.33-2.92 13-0.05 6.2 0.4 11.06 1.17 12.62 0.69 1.39 2.71 3.19 4.5 4 1.79 0.8 3.7 1.24 4.25 0.96 0.55-0.28 1-3.87 1-8v-7.5h10l0.5 15.5c4.65-0.37 7.13-1.62 8.5-3.01 2.27-2.29 2.53-3.45 2.81-12.26 0.22-6.52-0.11-10.69-1-12.63-0.72-1.6-2.21-3.52-3.31-4.26-1.37-0.93-5.28-1.35-12.33-1.35-10.09 0.01-10.39 0.08-13.17 2.93zm36.31-36.51c-2.77 2.38-2.81 2.58-2.81 13.59 0 10.94 0.06 11.22 2.75 13.59 2.55 2.23 3.55 2.41 13.75 2.41 10.01 0 11.22-0.2 13.46-2.25 1.36-1.24 2.71-3.49 3-5l0.54-2.75-15.5-0.5-0.5-10.5 16.5 0.05c-1.16-5.08-2.62-7.56-4-8.8-2.27-2.04-3.5-2.25-13.44-2.25-10.12 0-11.15 0.18-13.75 2.41zm59.05 9.4c-1.02 0.22-2.44 0.92-3.15 1.55-0.72 0.63-1.28 2.83-1.25 4.89 0.02 2.06 0.71 4.42 1.54 5.25 0.83 0.82 3.04 1.5 4.93 1.5 1.88 0 4.13-0.68 5-1.5 0.86-0.83 1.59-3.19 1.61-5.25 0.03-2.06-0.53-4.25-1.25-4.86-0.71-0.6-2.25-1.3-3.43-1.54-1.17-0.24-2.97-0.26-4-0.04zm-0.82 2.81c0.48-0.39 2.02-0.58 3.42-0.42 2.1 0.25 2.6 0.9 2.87 3.8 0.25 2.65-0.11 3.69-1.5 4.28-1.01 0.42-2.62 0.53-3.58 0.25q-1.75-0.54-1.92-3.86c-0.09-1.84 0.23-3.66 0.71-4.05zm14.41-2.51c-1.58 0.57-2.26 1.55-2.16 3.11 0.11 1.64 1.28 2.77 4.18 4.03 2.22 0.96 3.81 2.2 3.53 2.75-0.28 0.55-1.17 1-2 1-0.83 0-2.38-0.56-3.45-1.25-1.08-0.69-2.31-0.92-2.75-0.52-0.44 0.4-0.13 1.43 0.7 2.29 0.83 0.86 2.93 1.55 4.68 1.52 1.75-0.02 3.88-0.72 4.75-1.54 0.86-0.83 1.56-1.84 1.55-2.25 0-0.41-0.34-1.31-0.75-1.99-0.4-0.69-2.04-1.59-3.63-2-1.6-0.42-3.18-1.41-3.5-2.2-0.49-1.17 0.11-1.31 3.15-0.75 2.77 0.51 3.66 0.36 3.4-0.56-0.19-0.69-1.48-1.52-2.87-1.85-1.39-0.34-3.56-0.24-4.83 0.21zm-31.95 6.39c0 3.67 0.44 6.5 1 6.5 0.55 0 1.11-1.24 1.25-2.75 0.2-2.2 0.8-2.8 3-3 2.44-0.22 2.75 0.08 2.75 2.75q0 3 1.5 3c1.18 0 1.5-1.39 1.5-6.5 0-5.11-0.32-6.5-1.5-6.5-0.93 0-1.5 0.94-1.5 2.5 0 2.11-0.47 2.5-3 2.5-2.53 0-3-0.39-3-2.5 0-1.38-0.45-2.5-1-2.5-0.56 0-1 2.83-1 6.5zm43.05-0.05c-0.04 5.18 0.26 6.55 1.45 6.55 0.93 0 1.5-0.94 1.5-2.5 0-2.18 0.48-2.53 3.75-2.75 3.57-0.24 3.75-0.42 3.75-3.75v-3.5l-10.39-0.6zm2.94-2.45c0-1.47 0.67-2 2.5-2 1.84 0 2.5 0.53 2.5 2 0 1.46-0.66 2-2.5 2-1.83 0-2.5-0.54-2.5-2zm10 2.5c0 5.11 0.32 6.5 1.5 6.5 1.18 0 1.5-1.39 1.5-6.5 0-5.11-0.32-6.5-1.5-6.5-1.18 0-1.5 1.39-1.5 6.5zm5-5.5c0 0.55 1.13 1 2.5 1 2.37 0 2.5 0.3 2.5 5.5 0 3.02 0.45 5.5 1 5.5 0.55 0 1-2.48 1-5.5 0-5.2 0.14-5.5 2.5-5.5 1.38 0 2.5-0.45 2.5-1 0-0.56-2.66-1-6-1-3.33 0-6 0.44-6 1zm13.56 4.25c-1 2.89-1.98 5.81-2.18 6.5-0.21 0.69 0.3 1.25 1.12 1.25 0.83 0 1.73-0.68 2-1.5 0.28-0.83 1.63-1.5 3-1.5 1.38 0 2.73 0.67 3 1.5 0.28 0.82 1.18 1.5 2 1.5 0.83 0 1.5-0.34 1.5-0.75-0.01-0.41-1.02-3.34-2.25-6.5-1.73-4.42-2.72-5.75-4.31-5.75-1.59 0-2.48 1.2-3.88 5.25zm3.07-1c0.54-1.51 0.75-1.54 1.49-0.25 0.47 0.82 0.86 2.06 0.87 2.75 0.01 0.69-0.66 1.25-1.49 1.25-0.82 0-1.5-0.45-1.5-1 0-0.55 0.29-1.79 0.63-2.75zm9.37 2.25v6.5c7.75 0 10-0.45 10-1 0-0.55-1.46-1.11-3.25-1.25-3.18-0.25-3.25-0.36-3.5-5.5-0.18-3.89-0.64-5.25-1.75-5.25-1.18 0-1.5 1.39-1.5 6.5zm16 0v6.5c6.09 0 8.57-0.68 9.43-1.5 0.88-0.84 1.58-3.17 1.59-5.25 0.01-2.06-0.55-4.32-1.25-5.02-0.7-0.7-3.18-1.26-5.52-1.25l-4.25 0.02zm2-0.5c0-3.6 0.25-4 2.5-4 1.5 0 2.9 0.8 3.5 2 0.55 1.1 0.78 2.9 0.5 4-0.27 1.1-1.4 2.22-2.5 2.5-1.1 0.27-2.45 0.27-3 0-0.55-0.28-1-2.3-1-4.5zm-101.66 13.78c-1.01 0.21-2.41 1.14-3.1 2.05-0.7 0.92-1.28 3.02-1.29 4.67 0 1.65 0.79 3.8 1.77 4.78 1.16 1.15 2.97 1.68 5.18 1.5 1.87-0.16 3.9-1.05 4.5-1.98 0.61-0.94 0.77-2.06 0.36-2.5-0.41-0.44-1.67 0.1-2.81 1.2-1.63 1.57-2.43 1.76-3.76 0.89-1.03-0.68-1.69-2.42-1.69-4.5 0-2.87 0.39-3.44 2.5-3.71 1.53-0.2 2.79 0.29 3.25 1.25 0.42 0.86 1.2 1.57 1.75 1.57 0.55 0 0.97-0.86 0.93-1.9-0.05-1.18-1.15-2.25-2.91-2.8-1.56-0.5-3.67-0.73-4.68-0.52zm51.8 0.6c-1.06 0.64-2.54 2.41-3.28 3.95-1.16 2.38-1.14 3.17 0.18 5.48 1.11 1.95 2.48 2.78 5 3.03 2.17 0.21 4.12-0.25 5.21-1.25 0.97-0.88 1.75-2.04 1.75-2.59 0-0.55-0.67-1-1.5-1-0.82 0-1.72 0.67-2 1.5-0.27 0.83-1.45 1.39-2.64 1.25-1.19-0.14-2.6-0.93-3.14-1.75-0.54-0.83-0.7-2.74-0.35-4.25 0.48-2.1 1.23-2.75 3.13-2.75 1.38 0 2.73 0.67 3 1.5 0.28 0.82 1.18 1.5 2 1.5 0.83 0 1.51-0.34 1.52-0.75 0.01-0.41-0.55-1.48-1.25-2.37-0.7-0.9-2.26-1.86-3.49-2.14-1.22-0.28-3.08 0.01-4.14 0.64zm27.85-0.41c-1.25 0.34-2.43 1.38-2.63 2.32-0.2 0.94 0.04 2.27 0.53 2.96 0.48 0.69 2.28 1.59 4 2 1.77 0.42 3.11 1.4 3.11 2.25 0 0.93-0.94 1.5-2.5 1.5-1.37 0-2.5-0.45-2.5-1 0-0.55-0.67-1-1.5-1-0.82 0-1.5 0.34-1.51 0.75-0.01 0.41 0.55 1.32 1.25 2.01 0.69 0.7 2.64 1.26 4.31 1.25 1.68 0 3.6-0.57 4.27-1.26 0.67-0.69 1.21-2.04 1.2-3-0.01-1.08-1.56-2.42-4.05-3.5-2.21-0.96-4.02-2.2-4.01-2.75 0-0.64 1.54-0.7 4.28-0.17 3.5 0.68 4.06 0.59 3.14-0.5-0.62-0.73-2.02-1.59-3.12-1.9-1.1-0.31-3.02-0.29-4.27 0.04zm-71.86 5.78c-1.15 3.16-2.1 6.09-2.11 6.5-0.01 0.41 0.66 0.75 1.48 0.75 0.83 0 1.5-0.68 1.5-1.5q0-1.5 3-1.5c1.78 0 3.21 0.61 3.5 1.5 0.28 0.82 1.18 1.5 2 1.5 1.08 0 1.32-0.63 0.86-2.25-0.36-1.24-1.48-4.16-2.5-6.5-1.24-2.85-2.48-4.25-3.75-4.25-1.4 0-2.44 1.51-3.98 5.75zm4.07-3.25l0.91 2.5c0.5 1.37 0.79 2.63 0.65 2.8-0.14 0.17-0.99 0.17-1.88 0-1.31-0.24-1.44-0.79-0.65-2.8zm8.8 4c0 5.11 0.32 6.5 1.5 6.5 0.93 0 1.5-0.95 1.5-2.5 0-1.71 0.56-2.51 1.75-2.53 0.96-0.02 2.31 1.11 3 2.5 0.69 1.39 1.92 2.53 2.75 2.53 1.21 0 1.29-0.43 0.41-2.25-0.81-1.67-0.77-2.97 0.15-5 1.01-2.25 0.98-3.04-0.16-4.3-0.9-0.99-3.09-1.53-6.15-1.5l-4.75 0.05zm3.07-2.57c0.06-1.64 0.63-2 2.75-1.75 1.57 0.19 2.68 0.94 2.68 1.82 0 0.91-1.08 1.6-2.75 1.75-2.21 0.2-2.74-0.16-2.68-1.82zm14.03-1.68c-0.48 1.24-1.68 3.99-2.69 6.12-1 2.13-1.73 4.04-1.62 4.25 0.12 0.21 0.88 0.38 1.71 0.38 0.82 0 1.72-0.68 2-1.5 0.3-0.89 1.72-1.5 3.5-1.5q3 0 3 1.5c0 0.83 0.89 1.5 2 1.5 1.92 0 1.89-0.25-0.75-6.53-1.93-4.57-3.28-6.51-4.52-6.5-0.97 0.02-2.16 1.04-2.63 2.28zm2 1.69c0.06-0.58 0.39-0.87 0.75-0.63 0.36 0.24 0.99 1.39 1.4 2.56 0.6 1.71 0.36 2.13-1.25 2.13q-2 0-1.5-1.5c0.27-0.83 0.55-1.98 0.6-2.56zm26-1.69c-0.48 1.24-1.68 3.99-2.69 6.12-1 2.13-1.73 4.04-1.62 4.25 0.12 0.21 0.88 0.38 1.71 0.38 0.82 0 1.72-0.68 2-1.5 0.3-0.89 1.72-1.5 3.5-1.5q3 0 3 1.5c0 0.83 0.89 1.5 2 1.5 1.92 0 1.89-0.25-0.75-6.53-1.93-4.57-3.28-6.51-4.52-6.5-0.97 0.02-2.16 1.04-2.63 2.28zm2 1.69c0.06-0.58 0.39-0.87 0.75-0.63 0.36 0.24 0.99 1.39 1.4 2.56 0.6 1.71 0.36 2.13-1.25 2.13q-2 0-1.5-1.5c0.27-0.83 0.55-1.98 0.6-2.56z"/>
        </svg>
      </div>
      <div class="main-header-titles">
        <h1>HCC – Sistema de Médicos</h1>
        <p class="subtitulo">
          Directorio interactivo de médicos principales y asociados. Filtros avanzados, ficha individual y herramientas de difusión.
        </p>
      </div>
    </header>

    <!-- [SEC-120] ACCIONES SUPERIORES (EXPORTAR) -->
    <div class="top-actions">
      <button type="button" id="btn-export-pdf" class="btn-export">Exportar a PDF</button>
    </div>

    <!-- [SEC-130] FILTROS Y CONTROL DE COLUMNAS -->
    <div class="layout-top">
      <!-- Filtros -->
      <div id="filtros" class="panel">
        <div class="panel-title">Filtros</div>
        <div class="panel-body filtros-grid">
          <div class="filtro filtro-busqueda">
            <label for="busqueda">Buscar por nombre o apellido</label>
            <input type="text" id="busqueda" placeholder="Ej: Pérez, Ana, Luis..." />
          </div>

          <!-- Estatus multi selección -->
          <div class="filtro filtro-multi">
            <div class="filtro-title">Estatus</div>
            <div class="filtro-chips" id="chips-estatus"></div>
          </div>

          <div class="filtro">
            <label for="filtro-especialidad">Especialidad</label>
            <select id="filtro-especialidad"></select>
          </div>

          <div class="filtro">
            <label for="filtro-piso">Piso</label>
            <select id="filtro-piso"></select>
          </div>

          <div class="filtro">
            <label for="filtro-tipoacc">Tipo ACC</label>
            <select id="filtro-tipoacc"></select>
          </div>

          <div class="filtro">
            <label for="filtro-correo">Correo</label>
            <select id="filtro-correo">
              <option value="">Todos</option>
              <option value="Con correo corporativo">Con correo corporativo</option>
              <option value="Con correo personal">Con correo personal</option>
              <option value="Solo corporativo">Solo corporativo</option>
              <option value="Solo personal">Solo personal</option>
              <option value="Sin correo">Sin correo</option>
            </select>
          </div>

          <div class="filtro">
            <label for="filtro-celular">Celular</label>
            <select id="filtro-celular">
              <option value="">Todos</option>
              <option value="Con celular">Con celular</option>
              <option value="Sin celular">Sin celular</option>
            </select>
          </div>

          <div class="filtro filtro-botones">
            <button type="button" id="btn-limpiar">Limpiar filtros</button>
          </div>
        </div>
      </div>

      <!-- Control de columnas -->
      <div id="controles_columnas" class="panel">
        <div class="panel-title">Columnas</div>
        <div class="panel-body" id="panel-columnas"></div>
      </div>
    </div>

    <!-- [SEC-140] RESUMEN DE GRUPO FILTRADO -->
    <div class="summary-panel">
      <span id="summary-text">Mostrando miembros actuales.</span>
      &nbsp;
      <a href="#" id="link-contact-group">Contactar a este grupo…</a>
    </div>

    <!-- [SEC-150] TABLAS PRINCIPALES Y ASOCIADOS -->
    <div class="section-tablas">
      <h2>Principales</h2>
      <div id="tabla-principales-container"></div>

      <h2>Asociados</h2>
      <div id="tabla-asociados-container"></div>
    </div>
  </div>

  <!-- [SEC-201] MODAL CONTACTO INDIVIDUAL -->
  <div id="modal-backdrop" class="modal-backdrop">
    <div class="modal modal-mobile">
      <div class="modal-header">
        <span id="modal-title-text">Contacto</span>
        <button type="button" class="btn btn-secondary btn-icon" id="modal-close">✕</button>
      </div>
      <div class="modal-body">
        <div id="modal-contact-links" class="contact-links"></div>

        <div class="modal-section-title">Datos básicos</div>
        <div id="modal-fields-basic" class="modal-field-group"></div>

        <div class="modal-section-title">Datos profesionales</div>
        <div id="modal-fields-pro" class="modal-field-group"></div>

        <div class="modal-section-title">Contacto</div>
        <div id="modal-fields-contact" class="modal-field-group"></div>

        <div class="modal-section-title">Otros</div>
        <div id="modal-fields-other" class="modal-field-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="btn-modal-cancel">Cerrar</button>
        <button type="button" class="btn btn-danger" id="btn-modal-borrar">Borrar</button>
        <button type="button" class="btn btn-primary" id="btn-modal-modificar">Guardar cambios</button>
        <button type="button" class="btn btn-primary" id="btn-modal-new">Agregar nuevo accionista</button>
      </div>
    </div>
  </div>

  <!-- [SEC-202] MODAL NUEVO ACCIONISTA -->
  <div id="modal-new-backdrop" class="modal-backdrop">
    <div class="modal modal-mobile">
      <div class="modal-header">
        <span>Nuevo accionista</span>
        <button type="button" class="btn btn-secondary btn-icon" id="modal-new-close">✕</button>
      </div>
      <div class="modal-body">
        <p class="modal-help-text">
          Complete los datos del nuevo accionista. Se añadirá a la tabla correspondiente en orden alfabético.
        </p>
        <div id="modal-new-fields" class="modal-field-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="btn-modal-new-cancel">Cerrar</button>
        <button type="button" class="btn btn-primary" id="btn-modal-new-save">Guardar nuevo accionista</button>
      </div>
    </div>
  </div>

  <!-- [SEC-203] MODAL DIFUSIÓN / GRUPO FILTRADO -->
  <div id="modal-bulk-backdrop" class="modal-backdrop">
    <div class="modal modal-wide">
      <div class="modal-header">
        <span>Lista de difusión del grupo filtrado</span>
        <button type="button" class="btn btn-secondary btn-icon" id="bulk-close">✕</button>
      </div>
      <div class="modal-body">
        <p class="modal-help-text">
          Aquí tienes los contactos del grupo actualmente visible. Puedes copiar listas de correos o celulares
          y pegar en tu app de correo, SMS o WhatsApp. También puedes escribir el mensaje base abajo.
        </p>
        <div class="bulk-fields">
          <div>
            <div class="bulk-field-label">Correos corporativos:</div>
            <textarea id="bulk-corp"></textarea>
          </div>
          <div>
            <div class="bulk-field-label">Correos personales:</div>
            <textarea id="bulk-pers"></textarea>
          </div>
          <div>
            <div class="bulk-field-label">Celulares (+58...):</div>
            <textarea id="bulk-cel"></textarea>
          </div>
          <div>
            <div class="bulk-field-label">Mensaje sugerido:</div>
            <textarea id="bulk-msg" placeholder="Escribe aquí el mensaje que quieres enviar..."></textarea>
          </div>
        </div>
        <div class="bulk-buttons">
          <button type="button" class="btn btn-secondary" id="bulk-copy-corp">Copiar correos corporativos</button>
          <button type="button" class="btn btn-secondary" id="bulk-copy-pers">Copiar correos personales</button>
          <button type="button" class="btn btn-secondary" id="bulk-copy-cel">Copiar celulares</button>
          <button type="button" class="btn btn-primary" id="bulk-copy-msg">Copiar mensaje</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="bulk-btn-cancel">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- [SEC-301] LÓGICA JS PRINCIPAL -->
  <script>
    // [SEC-302] CONSTANTES DE COLUMNAS Y METADATOS
    const COL_N   = 0;
    const COL_APE = 1;
    const COL_NOM = 2;
    const COL_EST = 3;
    const COL_ESP = 4;
    const COL_ACC = 5;
    const COL_CEL = 6;
    const COL_PISO= 8;
    const COL_CORP=10;
    const COL_PERS=11;

    const STATUS_WEIGHT = { 'ACTIVO': 0, 'INACTIVO': 1, 'FALLECIDO': 2 };

    const HCC_COLUMNS = (window.HCC_META && window.HCC_META.columns) || [];
    const HCC_DATA    = (window.HCC_META && window.HCC_META.data) || [];

    let modalRow = null;
    let modalTableId = null;
    let newRecordTableId = null;

    // columnas visibles por defecto
    const DEFAULT_VISIBLE_COLS = new Set(['N°','APELLIDOS','NOMBRES','ESTATUS','ESPECIALIDAD']);

    // [SEC-303] UTILIDADES GENERALES
    function getCellText(row, colIndex) {
      const cell = row.querySelector('.col-' + colIndex);
      return cell ? cell.textContent.trim() : '';
    }

    function formatCellHTML(col, value) {
      const val = value.trim();
      if (!val) return '';

      if (col === COL_CEL) {
        const digits = val.replace(/\D/g, '');
        if (digits.length >= 10) {
          const href = 'tel:+' + digits;
          return '<a href="' + href + '">' + val + '</a>';
        }
        return val;
      }
      if (col === COL_CORP || col === COL_PERS) {
        if (val.indexOf('@') !== -1) {
          return '<a href="mailto:' + val + '">' + val + '</a>';
        }
      }
      return val;
    }

    function getSelectedValues(selector) {
      const vals = [];
      document.querySelectorAll(selector + ':checked').forEach(chk => {
        vals.push(chk.value.trim());
      });
      return vals;
    }

    // [SEC-304] CONTROLES DE COLUMNAS (CHECKBOX)
    function buildColumnControls() {
      const panel = document.getElementById('panel-columnas');
      panel.innerHTML = '';
      const allCols = ['N°'].concat(HCC_COLUMNS);

      allCols.forEach((colName, idx) => {
        const label = document.createElement('label');
        label.className = 'chk-col';

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'chk-toggle-col';
        input.dataset.col = idx;
        if (DEFAULT_VISIBLE_COLS.has(colName)) input.checked = true;
        else input.checked = false;

        label.appendChild(input);
        label.append(' ' + colName);
        panel.appendChild(label);
      });
    }

    function applyColumnToggles() {
      const checks = document.querySelectorAll('.chk-toggle-col');
      const tables = [document.getElementById('tabla_principales'), document.getElementById('tabla_asociados')];

      checks.forEach(chk => {
        const colIndex = parseInt(chk.dataset.col, 10);
        const show = chk.checked;
        tables.forEach(tbl => {
          if (!tbl) return;
          const cells = tbl.querySelectorAll('.col-' + colIndex);
          cells.forEach(cell => {
            cell.style.display = show ? '' : 'none';
          });
        });
      });
    }

    function setupColumnControls() {
      document.querySelectorAll('.chk-toggle-col').forEach(chk => {
        chk.addEventListener('change', applyColumnToggles);
      });
    }

    // [SEC-305] CONSTRUCCIÓN DE TABLAS
    function buildTable(tableId, containerId, tipoAcc) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';

      const wrapper = document.createElement('div');
      wrapper.className = 'tabla-wrapper';

      const inner = document.createElement('div');
      inner.className = 'tabla-wrapper-inner';

      const table = document.createElement('table');
      table.id = tableId;
      table.className = 'tabla-hcc';

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');

      let thN = document.createElement('th');
      thN.className = 'col-0';
      thN.textContent = 'N°';
      trh.appendChild(thN);

      HCC_COLUMNS.forEach((colName, idx) => {
        const th = document.createElement('th');
        th.className = 'col-' + (idx + 1);
        th.textContent = colName;
        trh.appendChild(th);
      });

      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      HCC_DATA.forEach(rec => {
        const tAcc = (rec['TIPO ACC'] || '').toUpperCase().trim();
        if ((tipoAcc === 'PRINCIPAL' && tAcc !== 'PRINCIPAL') ||
            (tipoAcc === 'ASOCIADO' && tAcc !== 'ASOCIADO')) {
          return;
        }

        const tr = document.createElement('tr');

        const tdN = document.createElement('td');
        tdN.className = 'col-0';
        tdN.textContent = '';
        tr.appendChild(tdN);

        HCC_COLUMNS.forEach((colName, cIdx) => {
          const td = document.createElement('td');
          const colIndex = cIdx + 1;
          td.className = 'col-' + colIndex;
          const rawVal = rec[colName] != null ? String(rec[colName]) : '';
          td.innerHTML = formatCellHTML(colIndex, rawVal);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      inner.appendChild(table);
      wrapper.appendChild(inner);
      container.appendChild(wrapper);
    }

    function buildTablesFromData() {
      buildTable('tabla_principales', 'tabla-principales-container', 'PRINCIPAL');
      buildTable('tabla_asociados',  'tabla-asociados-container',  'ASOCIADO');
    }

    // [SEC-306] OPCIONES DE FILTROS (COMBOS / CHIPS)
    function fillSimpleSelect(id, values) {
      const sel = document.getElementById(id);
      sel.innerHTML = '<option value="">Todos</option>';
      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
    }

    function buildFilterOptionsFromData() {
      const all = HCC_DATA || [];

      const estatusSet = new Set();
      const espSet = new Set();
      const pisoSet = new Set();
      const tipoSet = new Set();

      all.forEach(rec => {
        if (rec['ESTATUS']) estatusSet.add(rec['ESTATUS'].trim());
        if (rec['ESPECIALIDAD']) espSet.add(rec['ESPECIALIDAD'].trim());
        if (rec['PISO']) pisoSet.add(rec['PISO'].trim());
        if (rec['TIPO ACC']) tipoSet.add(rec['TIPO ACC'].trim());
      });

      const chips = document.getElementById('chips-estatus');
      chips.innerHTML = '';
      Array.from(estatusSet).sort().forEach(val => {
        const label = document.createElement('label');
        label.className = 'chip-filter';
        const inp = document.createElement('input');
        inp.type = 'checkbox';
        inp.className = 'flt-estatus';
        inp.value = val;
        label.appendChild(inp);
        label.append(' ' + val);
        chips.appendChild(label);
      });

      fillSimpleSelect('filtro-especialidad', Array.from(espSet).sort());
      fillSimpleSelect('filtro-piso', Array.from(pisoSet).sort());
      fillSimpleSelect('filtro-tipoacc', Array.from(tipoSet).sort());
    }

    // [SEC-307] APLICAR FILTROS
    function applyFilters() {
      const searchValue = document.getElementById('busqueda').value.trim().toLowerCase();
      const estatusSelected = getSelectedValues('.flt-estatus');
      const espValue   = document.getElementById('filtro-especialidad').value.trim();
      const pisoValue  = document.getElementById('filtro-piso').value.trim();
      const tipoAccVal = document.getElementById('filtro-tipoacc').value.trim();
      const correoVal  = document.getElementById('filtro-correo').value.trim();
      const celVal     = document.getElementById('filtro-celular').value.trim();

      const tables = [document.getElementById('tabla_principales'), document.getElementById('tabla_asociados')];

      tables.forEach(tbl => {
        if (!tbl) return;
        const rows = tbl.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const apellidos    = getCellText(row, COL_APE).toLowerCase();
          const nombres      = getCellText(row, COL_NOM).toLowerCase();
          const estatus      = getCellText(row, COL_EST);
          const especialidad = getCellText(row, COL_ESP);
          const tipoAcc      = getCellText(row, COL_ACC);
          const piso         = getCellText(row, COL_PISO);
          const corp         = getCellText(row, COL_CORP);
          const pers         = getCellText(row, COL_PERS);
          const cel          = getCellText(row, COL_CEL);

          let visible = true;

          if (searchValue) {
            if (!apellidos.includes(searchValue) && !nombres.includes(searchValue)) visible = false;
          }

          if (estatusSelected.length > 0 && !estatusSelected.includes(estatus)) visible = false;
          if (espValue && especialidad !== espValue) visible = false;
          if (pisoValue && piso !== pisoValue) visible = false;
          if (tipoAccVal && tipoAcc !== tipoAccVal) visible = false;

          if (correoVal) {
            const hasCorp = !!corp;
            const hasPers = !!pers;
            if (correoVal === 'Con correo corporativo' && !hasCorp) visible = false;
            if (correoVal === 'Con correo personal' && !hasPers) visible = false;
            if (correoVal === 'Solo corporativo' && (!hasCorp || hasPers)) visible = false;
            if (correoVal === 'Solo personal' && (!hasPers || hasCorp)) visible = false;
            if (correoVal === 'Sin correo' && (hasCorp || hasPers)) visible = false;
          }

          if (celVal) {
            const hasCel = !!cel;
            if (celVal === 'Con celular' && !hasCel) visible = false;
            if (celVal === 'Sin celular' && hasCel) visible = false;
          }

          row.style.display = visible ? '' : 'none';
        });
      });

      renumerarTodo();
      updateSummary();
    }

    function setupFilters() {
      document.getElementById('busqueda').addEventListener('input', applyFilters);
      document.getElementById('filtro-especialidad').addEventListener('change', applyFilters);
      document.getElementById('filtro-piso').addEventListener('change', applyFilters);
      document.getElementById('filtro-tipoacc').addEventListener('change', applyFilters);
      document.getElementById('filtro-correo').addEventListener('change', applyFilters);
      document.getElementById('filtro-celular').addEventListener('change', applyFilters);
      document.addEventListener('change', function(e) {
        if (e.target.classList.contains('flt-estatus')) applyFilters();
      });
      document.getElementById('btn-limpiar').addEventListener('click', function() {
        document.getElementById('busqueda').value = '';
        document.getElementById('filtro-especialidad').value = '';
        document.getElementById('filtro-piso').value = '';
        document.getElementById('filtro-tipoacc').value = '';
        document.getElementById('filtro-correo').value = '';
        document.getElementById('filtro-celular').value = '';
        document.querySelectorAll('.flt-estatus').forEach(chk => chk.checked = false);
        applyFilters();
      });
    }

    // [SEC-308] ORDEN Y NUMERACIÓN DINÁMICA
    function renumerarTabla(tableId) {
      const tbl = document.getElementById(tableId);
      if (!tbl) return;
      const rows = tbl.querySelectorAll('tbody tr');
      let n = 1;
      rows.forEach(row => {
        const cell = row.querySelector('.col-0');
        if (!cell) return;
        if (row.style.display === 'none') {
          cell.textContent = '';
        } else {
          cell.textContent = n;
          n++;
        }
      });
    }

    function renumerarTodo() {
      renumerarTabla('tabla_principales');
      renumerarTabla('tabla_asociados');
    }

    function sortTableByApellidoEstatus(tableId) {
      const tbl = document.getElementById(tableId);
      if (!tbl) return;
      const tbody = tbl.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.sort((a, b) => {
        const apeA = getCellText(a, COL_APE).toUpperCase();
        const apeB = getCellText(b, COL_APE).toUpperCase();
        if (apeA < apeB) return -1;
        if (apeA > apeB) return 1;

        const estA = getCellText(a, COL_EST).toUpperCase();
        const estB = getCellText(b, COL_EST).toUpperCase();
        const wA = STATUS_WEIGHT.hasOwnProperty(estA) ? STATUS_WEIGHT[estA] : 99;
        const wB = STATUS_WEIGHT.hasOwnProperty(estB) ? STATUS_WEIGHT[estB] : 99;
        if (wA < wB) return -1;
        if (wA > wB) return 1;

        const nomA = getCellText(a, COL_NOM).toUpperCase();
        const nomB = getCellText(b, COL_NOM).toUpperCase();
        if (nomA < nomB) return -1;
        if (nomA > nomB) return 1;
        return 0;
      });

      rows.forEach(r => tbody.appendChild(r));
    }

    function sortAllTables() {
      sortTableByApellidoEstatus('tabla_principales');
      sortTableByApellidoEstatus('tabla_asociados');
    }

    // [SEC-309] MODAL DE CONTACTO
    function openModalForRow(row, tableId) {
      modalRow = row;
      modalTableId = tableId;
      newRecordTableId = tableId;

      const backdrop = document.getElementById('modal-backdrop');
      const contactLinks = document.getElementById('modal-contact-links');
      const basic = document.getElementById('modal-fields-basic');
      const pro = document.getElementById('modal-fields-pro');
      const contact = document.getElementById('modal-fields-contact');
      const other = document.getElementById('modal-fields-other');

      contactLinks.innerHTML = '';
      basic.innerHTML = '';
      pro.innerHTML = '';
      contact.innerHTML = '';
      other.innerHTML = '';

      const headerCells = row.closest('table').querySelectorAll('thead th');

      const apellidos = getCellText(row, COL_APE);
      const nombres   = getCellText(row, COL_NOM);
      const nombreCompleto = (apellidos + ' ' + nombres).trim();
      document.getElementById('modal-title-text').textContent = nombreCompleto || 'Contacto';

      const tel = getCellText(row, COL_CEL);
      const corp = getCellText(row, COL_CORP);
      const pers = getCellText(row, COL_PERS);

      if (tel) {
        const digits = tel.replace(/\D/g, '');
        if (digits.length >= 10) {
          const href = 'tel:+' + digits;
          const a = document.createElement('a');
          a.href = href;
          a.textContent = 'Llamar';
          contactLinks.appendChild(a);
        }
      }
      if (corp && corp.indexOf('@') !== -1) {
        const a = document.createElement('a');
        a.href = 'mailto:' + corp;
        a.textContent = 'Correo corporativo';
        contactLinks.appendChild(a);
      }
      if (pers && pers.indexOf('@') !== -1) {
        const a = document.createElement('a');
        a.href = 'mailto:' + pers;
        a.textContent = 'Correo personal';
        contactLinks.appendChild(a);
      }

      headerCells.forEach((th, idx) => {
        const label = th.textContent.trim();
        const cell = row.querySelector('.col-' + idx);
        let value = cell ? cell.textContent.trim() : '';

        const disabled = (idx === COL_N) ? 'disabled' : '';

        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'modal-field';
        fieldDiv.innerHTML =
          '<label>' + label + '</label>' +
          '<input type="text" data-col="' + idx + '" value="' +
          value.replace(/"/g, '&quot;') + '" ' + disabled + '>';

        if (idx === COL_N || idx === COL_APE || idx === COL_NOM) {
          basic.appendChild(fieldDiv);
        } else if (idx === COL_ESP || idx === COL_ACC || idx === COL_PISO || idx === COL_EST) {
          pro.appendChild(fieldDiv);
        } else if (idx === COL_CEL || idx === COL_CORP || idx === COL_PERS) {
          contact.appendChild(fieldDiv);
        } else {
          other.appendChild(fieldDiv);
        }
      });

      backdrop.style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal-backdrop').style.display = 'none';
      modalRow = null;
      modalTableId = null;
    }

    function applyModify() {
      if (!modalRow) return;
      if (!confirm('¿Seguro que deseas MODIFICAR este registro?')) return;

      document.querySelectorAll('#modal-backdrop input[data-col]').forEach(input => {
        const col = parseInt(input.dataset.col, 10);
        if (col === COL_N) return;
        const newVal = input.value.trim();
        const cell = modalRow.querySelector('.col-' + col);
        if (!cell) return;
        cell.innerHTML = formatCellHTML(col, newVal);
      });

      sortAllTables();
      applyFilters();
      closeModal();
    }

    function applyDelete() {
      if (!modalRow) return;
      if (!confirm('¿Seguro que deseas BORRAR este registro?')) return;

      modalRow.parentNode.removeChild(modalRow);
      renumerarTodo();
      updateSummary();
      closeModal();
    }

    // [SEC-310] MODAL “NUEVO ACCIONISTA”
    function openNewAccionistaModal() {
      if (!newRecordTableId) return;

      const tbl = document.getElementById(newRecordTableId);
      if (!tbl) return;

      const headerCells = tbl.querySelectorAll('thead th');
      const container = document.getElementById('modal-new-fields');
      container.innerHTML = '';

      headerCells.forEach((th, idx) => {
        if (idx === COL_N) return;
        const label = th.textContent.trim();
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'modal-field';
        fieldDiv.innerHTML =
          '<label>' + label + '</label>' +
          '<input type="text" data-col="' + idx + '" value="">';
        container.appendChild(fieldDiv);
      });

      document.getElementById('modal-new-backdrop').style.display = 'flex';
    }

    function closeNewAccionistaModal() {
      document.getElementById('modal-new-backdrop').style.display = 'none';
    }

    function saveNewAccionista() {
      if (!newRecordTableId) return;
      const tbl = document.getElementById(newRecordTableId);
      if (!tbl) return;

      const tbody = tbl.querySelector('tbody');
      const newRow = document.createElement('tr');

      const tdN = document.createElement('td');
      tdN.className = 'col-' + COL_N;
      tdN.textContent = '';
      newRow.appendChild(tdN);

      document.querySelectorAll('#modal-new-fields input').forEach(input => {
        const col = parseInt(input.dataset.col, 10);
        const td = document.createElement('td');
        td.className = 'col-' + col;
        const val = input.value.trim();
        td.innerHTML = formatCellHTML(col, val);
        newRow.appendChild(td);
      });

      tbody.appendChild(newRow);

      sortAllTables();
      applyFilters();
      closeNewAccionistaModal();
    }

    // [SEC-311] MODAL DIFUSIÓN / COPIAR LISTAS
    function collectVisibleContacts() {
      const principalTbl = document.getElementById('tabla_principales');
      const asociadoTbl  = document.getElementById('tabla_asociados');

      const corporativos = [];
      const personales   = [];
      const celulares    = [];

      function collectFromTable(tbl) {
        if (!tbl) return;
        const rows = tbl.querySelectorAll('tbody tr');
        rows.forEach(row => {
          if (row.style.display === 'none') return;
          const corp = getCellText(row, COL_CORP);
          const pers = getCellText(row, COL_PERS);
          const cel  = getCellText(row, COL_CEL);
          if (corp && !corporativos.includes(corp)) corporativos.push(corp);
          if (pers && !personales.includes(pers)) personales.push(pers);
          if (cel  && !celulares.includes(cel)) celulares.push(cel);
        });
      }

      collectFromTable(principalTbl);
      collectFromTable(asociadoTbl);

      return { corporativos, personales, celulares };
    }

    function copyToClipboard(text) {
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); } catch (e) {}
        document.body.removeChild(ta);
      }
    }

    function openBulkModal() {
      const backdrop = document.getElementById('modal-bulk-backdrop');
      const corpTa   = document.getElementById('bulk-corp');
      const persTa   = document.getElementById('bulk-pers');
      const celTa    = document.getElementById('bulk-cel');
      const msgTa    = document.getElementById('bulk-msg');

      const data = collectVisibleContacts();

      corpTa.value = data.corporativos.join('; ');
      persTa.value = data.personales.join('; ');
      celTa.value  = data.celulares.join(', ');
      msgTa.value  = '';

      backdrop.style.display = 'flex';
    }

    function closeBulkModal() {
      document.getElementById('modal-bulk-backdrop').style.display = 'none';
    }

    function setupBulkModal() {
      const link = document.getElementById('link-contact-group');
      if (link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          openBulkModal();
        });
      }

      document.getElementById('bulk-close').addEventListener('click', closeBulkModal);
      document.getElementById('bulk-btn-cancel').addEventListener('click', closeBulkModal);

      document.getElementById('bulk-copy-corp').addEventListener('click', function() {
        copyToClipboard(document.getElementById('bulk-corp').value);
      });
      document.getElementById('bulk-copy-pers').addEventListener('click', function() {
        copyToClipboard(document.getElementById('bulk-pers').value);
      });
      document.getElementById('bulk-copy-cel').addEventListener('click', function() {
        copyToClipboard(document.getElementById('bulk-cel').value);
      });
      document.getElementById('bulk-copy-msg').addEventListener('click', function() {
        copyToClipboard(document.getElementById('bulk-msg').value);
      });
    }

    // [SEC-312] RESUMEN (CONTADORES Y TOTAL ACCIONISTAS)
    function updateSummary() {
      const principalTbl = document.getElementById('tabla_principales');
      const asociadoTbl  = document.getElementById('tabla_asociados');
      const summaryEl    = document.getElementById('summary-text');
      if (!summaryEl) return;

      function countByStatus(tbl) {
        if (!tbl) return { total:0, ACTIVO:0, INACTIVO:0, FALLECIDO:0 };
        const rows = tbl.querySelectorAll('tbody tr');
        const res = { total:0, ACTIVO:0, INACTIVO:0, FALLECIDO:0 };
        rows.forEach(row => {
          if (row.style.display === 'none') return;
          res.total++;
          const est = getCellText(row, COL_EST).toUpperCase();
          if (res.hasOwnProperty(est)) res[est]++;
        });
        return res;
      }

      const p = countByStatus(principalTbl);
      const a = countByStatus(asociadoTbl);
      const totalAcc = p.total + a.total;

      function buildPart(label, c) {
        if (c.total === 0) return '0 ' + label;
        const parts = [];
        if (c.ACTIVO)    parts.push(c.ACTIVO + ' activos');
        if (c.INACTIVO)  parts.push(c.INACTIVO + ' inactivos');
        if (c.FALLECIDO) parts.push(c.FALLECIDO + ' fallecidos');
        return c.total + ' ' + label + ' (' + parts.join(', ') + ')';
      }

      const txt = 'Mostrando ' + buildPart('principales', p) +
                  ' y ' + buildPart('asociados', a) +
                  '. Total: ' + totalAcc + ' accionistas.';
      summaryEl.textContent = txt;
    }

    // [SEC-313] EVENTOS TABLAS / EXPORT PDF
    function setupRowEditing() {
      ['tabla_principales', 'tabla_asociados'].forEach(id => {
        const tbl = document.getElementById(id);
        if (!tbl) return;
        const tbody = tbl.querySelector('tbody');
        if (!tbody) return;

        tbody.addEventListener('click', function(e) {
          const row = e.target.closest('tr');
          if (!row) return;
          openModalForRow(row, id);
        });
      });

      document.getElementById('modal-close').addEventListener('click', closeModal);
      document.getElementById('btn-modal-cancel').addEventListener('click', closeModal);
      document.getElementById('btn-modal-borrar').addEventListener('click', applyDelete);
      document.getElementById('btn-modal-modificar').addEventListener('click', applyModify);
      document.getElementById('btn-modal-new').addEventListener('click', openNewAccionistaModal);

      document.getElementById('modal-new-close').addEventListener('click', closeNewAccionistaModal);
      document.getElementById('btn-modal-new-cancel').addEventListener('click', closeNewAccionistaModal);
      document.getElementById('btn-modal-new-save').addEventListener('click', saveNewAccionista);
    }

    function setupExportPDF() {
      const btn = document.getElementById('btn-export-pdf');
      if (!btn) return;
      btn.addEventListener('click', function() {
        window.print();
      });
    }

    // [SEC-314] INICIALIZACIÓN COMPLETA TRAS LOGIN
    function initApp() {
      buildColumnControls();
      buildFilterOptionsFromData();
      buildTablesFromData();

      setupColumnControls();
      setupFilters();
      setupRowEditing();
      setupExportPDF();
      setupBulkModal();

      applyColumnToggles();
      sortAllTables();
      applyFilters(); // renumera + resumen
    }

    // [SEC-315] LOGIN Y DESBLOQUEO (PASSWORD: ojodetigre)
    document.addEventListener('DOMContentLoaded', function() {
      const lock = document.getElementById('lock-screen');
      const app  = document.getElementById('app');
      const input = document.getElementById('pwd-input');
      const btn = document.getElementById('btn-login');
      const errorEl = document.getElementById('pwd-error');

      function tryLogin() {
        const val = input.value;
        if (val === 'ojodetigre') {
          lock.style.display = 'none';
          app.style.display = 'block';
          initApp();
        } else {
          errorEl.textContent = 'Contraseña incorrecta.';
          input.select();
        }
      }

      // Enfocamos el campo de password al cargar
      if (input) {
        input.focus();
        setTimeout(() => input.focus(), 150);
      }

      btn.addEventListener('click', tryLogin);
      input.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') tryLogin();
      });
    });
  </script>
</body>
</html>
