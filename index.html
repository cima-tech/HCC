<!DOCTYPE html>
<html lang="es">
<head>
  <!-- [SEC-001] METADATOS BÁSICOS -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DIME - HCC</title>

  <!-- [SEC-002] BASE DE DATOS (JSON JS EXTERNO) -->
  <script src="HCC_data.js"></script>

  <!-- [SEC-003] ESTILOS GLOBALES Y LAYOUT -->
  <style>
    :root {
      --color-base: #1c4e80;
      --color-secundario: #f0f4fb;
      --color-borde: #d0d7e2;
      --color-texto: #222;
      --radius: 8px;
      --shadow-soft: 0 2px 6px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; }

body {
  font-family: Arial, sans-serif;
  font-size: 12px;
  margin: 0;
  padding: 16px;
  /*alternar entre los dos */
  /* background: radial-gradient(circle at top, #2f6fb8, #0c1b2e); */ 
  background: #f5f7fb;  /* fondo clarito */
  color: var(--color-texto);
}
  
  color: var(--color-texto);
}
    /* [SEC-010] LOGIN / LOCK SCREEN */ 
    .lock-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #2f6fb8, #0c1b2e);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .lock-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 18px 20px 16px 20px;
      width: 90%;
      max-width: 360px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      text-align: center;
    }
    .lock-card h2 {
      margin: 0 0 4px 0;
      font-size: 18px;
      color: var(--color-base);
    }
    .lock-subtitle {
      font-size: 11px;
      color: #555;
      margin-bottom: 14px;
    }
    .lock-input {
      width: 100%;
      padding: 8px 10px;
      font-size: 16px;          /* >=16px para que iOS no haga zoom automático */
      border-radius: 8px;
      border: 1px solid #ccd3e2;
      margin-bottom: 10px;
    }
    .lock-input:focus {
      outline: none;
      border-color: var(--color-base);
      box-shadow: 0 0 0 1px rgba(28,78,128,0.18);
    }
    .lock-btn {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid var(--color-base);
      background: var(--color-base);
      color: #fff;
      cursor: pointer;
    }
    .lock-btn:hover {
      background: #163d62;
    }
    .lock-error {
      font-size: 11px;
      color: #e74c3c;
      min-height: 14px;
      margin-top: 6px;
    }

    /* [SEC-020] LAYOUT GENERAL APP */
    #app {
      display: none; /* se muestra al pasar el login */
    }

    .main-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      background: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: var(--shadow-soft);
      max-width: 980px;
      margin-left: auto;
      margin-right: auto;
    }

    .main-header-logo img {
  height: 40px;
  width: auto;
  display: block;
}
    .main-header-logo svg {
      height: 40px;
      width: auto;
      display: block;
    }

    .main-header-titles h1 {
      margin: 0;
      font-size: 18px;
      color: var(--color-base);
    }

    .main-header-titles .subtitulo {
      margin: 2px 0 0 0;
      font-size: 11px;
      color: #555;
    }

    .top-actions {
      display: flex;
      justify-content: flex-end;
      margin: 8px auto;
      max-width: 980px;
    }

    .btn-export {
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid var(--color-base);
      background: var(--color-base);
      color: #fff;
      cursor: pointer;
    }

    .btn-export:hover { background: #163d62; }

    .layout-top {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 0 auto 6px auto;
      max-width: 980px;
    }

    .panel {
      background: #fff;
      border-radius: var(--radius);
      border: 1px solid var(--color-borde);
      box-shadow: var(--shadow-soft);
    }

    .panel-title {
      padding: 6px 10px;
      border-bottom: 1px solid var(--color-borde);
      font-weight: bold;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #555;
    }

    .panel-body { padding: 8px 10px 10px 10px; }

    #controles_columnas {
      min-width: 220px;
      max-width: 260px;
      font-size: 11px;
    }

    .chk-col {
      display: inline-block;
      margin-right: 6px;
      margin-bottom: 4px;
      font-size: 10px;
      white-space: nowrap;
    }

    #filtros {
      flex: 1;
      min-width: 280px;
      font-size: 11px;
    }

    .filtros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px 10px;
      align-items: flex-start;
    }

    .filtro label {
      display: block;
      font-size: 10px;
      margin-bottom: 3px;
      color: #444;
    }

    .filtro input[type="text"],
    .filtro select {
      width: 100%;
      padding: 4px 6px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid var(--color-borde);
    }

    .filtro input[type="text"]:focus,
    .filtro select:focus {
      outline: none;
      border-color: var(--color-base);
      box-shadow: 0 0 0 1px rgba(28,78,128,0.15);
    }

    .filtro-botones { text-align: right; }

    #btn-limpiar {
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid var(--color-base);
      background: #fff;
      color: var(--color-base);
      cursor: pointer;
    }

    #btn-limpiar:hover { background: #f0f4ff; }

    .filtro-multi .filtro-title {
      font-size: 10px;
      margin-bottom: 3px;
      color: #444;
    }

    .filtro-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .chip-filter {
      font-size: 10px;
      border-radius: 12px;
      border: 1px solid var(--color-borde);
      padding: 2px 6px;
      background: #f8f9ff;
      cursor: pointer;
    }

    .chip-filter input { margin-right: 3px; }

    .section-tablas {
      margin-top: 8px;
      max-width: 980px;
      margin-left: auto;
      margin-right: auto;
    }

    h2 {
      margin-top: 16px;
      margin-bottom: 4px;
      font-size: 16px;
      color: var(--color-base);
    }

    .tabla-wrapper {
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
    }

    .tabla-wrapper-inner {
      max-width: 960px;
      margin: 0 auto;
    }

    /* [SEC-030] TABLAS PRINCIPALES (NO SELECCIONABLES, RESPONSIVE, ANCHO MÁXIMO) */
    .tabla-wrapper,
    .tabla-hcc,
    .tabla-hcc * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .tabla-hcc {
      border-collapse: collapse;
      width: 100%;
      margin-top: 4px;
      background: #fff;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      min-width: 600px;
      font-size: 10px;
      table-layout: fixed;              /* clave para que no se expanda infinito */
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .tabla-hcc thead {
      background: var(--color-base);
      color: #fff;
    }

    .tabla-hcc th,
    .tabla-hcc td {
      border: 1px solid var(--color-borde);
      padding: 3px 4px;
      font-size: 10px;
      text-align: left;
    }

    /* [SEC-031] COLUMNA NÚMERO SIEMPRE ANGOSTA */
    .tabla-hcc th.col-0,
    .tabla-hcc td.col-0 {
      width: 32px;
      max-width: 32px;
      min-width: 28px;
      text-align: center;
      white-space: nowrap;
    }

    /* Sin clamp en APELLIDOS/NOMBRES para evitar confusión visual */

    .tabla-hcc tbody tr:nth-child(odd) { background: #fafbff; }
    .tabla-hcc tbody tr:hover { background: #fff5e5; }

    .tabla-hcc a {
      color: var(--color-base);
      text-decoration: none;
    }
    .tabla-hcc a:hover { text-decoration: underline; }

    /* [SEC-040] MODALES TIPO “MÓVIL” */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      border-radius: var(--radius);
      border: 1px solid var(--color-borde);
      box-shadow: 0 8px 20px rgba(0,0,0,0.20);
      max-width: 520px;
      width: 95%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .modal-mobile { max-width: 420px; }
    .modal-wide   { max-width: 640px; }

    .modal,
    .modal * {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    .modal-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--color-borde);
      font-weight: bold;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 10px 14px 12px 14px;
      overflow-y: auto;
      background: #f7f9fc;
    }

    .modal-footer {
      padding: 8px 12px;
      border-top: 1px solid var(--color-borde);
      text-align: right;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      background: #fff;
    }

    .modal-help-text {
      font-size: 11px;
      color: #555;
      margin-top: 0;
      margin-bottom: 8px;
    }

    .modal-section-title {
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #777;
      margin: 8px 0 4px 0;
    }

    .modal-field-group {
      background: #ffffff;
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      margin-bottom: 6px;
    }

    .modal-field { margin-bottom: 6px; }
    .modal-field:last-child { margin-bottom: 0; }

    .modal-field label {
      display: block;
      font-size: 10px;
      margin-bottom: 2px;
      color: #777;
    }

    .modal-field input {
      width: 100%;
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #dde2ee;
      background: #f5f7fd;
    }

    .modal-field input:focus {
      outline: none;
      border-color: var(--color-base);
      background: #fff;
      box-shadow: 0 0 0 1px rgba(28,78,128,0.18);
    }

    .contact-links {
      margin-bottom: 6px;
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .contact-links a {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--color-base);
      color: var(--color-base);
      background: #fff;
      text-decoration: none;
      font-size: 11px;
    }

    .contact-links a:hover {
      background: var(--color-base);
      color: #fff;
    }

    /* [SEC-050] MODAL DIFUSIÓN / LISTA GRUPO */
    .bulk-fields {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .bulk-fields textarea {
      width: 100%;
      min-height: 50px;
      resize: vertical;
      font-size: 11px;
      font-family: monospace;
      border-radius: 4px;
      border: 1px solid var(--color-borde);
      padding: 4px 5px;
    }

    .bulk-field-label {
      font-size: 10px;
      margin-bottom: 2px;
      color: #444;
    }

    .bulk-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    /* [SEC-060] BOTONES GENERALES */
    .btn {
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid transparent;
      cursor: pointer;
    }

    .btn-secondary {
      border-color: #aaa;
      background: #fff;
      color: #444;
    }

    .btn-secondary:hover { background: #f0f0f0; }

    .btn-primary {
      border-color: var(--color-base);
      background: var(--color-base);
      color: #fff;
    }

    .btn-primary:hover { background: #163d62; }

    .btn-danger {
      border-color: #c0392b;
      background: #e74c3c;
      color: #fff;
    }

    .btn-danger:hover { background: #c0392b; }

    .btn-icon {
      width: 24px;
      height: 24px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    /* [SEC-070] RESUMEN */
    .summary-panel {
      margin: 6px auto 0 auto;
      font-size: 11px;
      color: #333;
      max-width: 980px;
    }

    .summary-panel a {
      color: var(--color-base);
      text-decoration: underline;
      cursor: pointer;
    }

    /* [SEC-080] RESPONSIVE */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .layout-top { flex-direction: column; }
      .section-tablas { max-width: 100%; }
      .tabla-hcc { min-width: 0; }
    }

    /* [SEC-090] MODO IMPRESIÓN / PDF */
    @media print {
      .lock-screen { display: none !important; }
      .main-header,
      .top-actions,
      .layout-top,
      .summary-panel,
      #modal-backdrop,
      #modal-bulk-backdrop,
      #modal-new-backdrop {
        display: none !important;
      }
      body {
        background: #fff;
        padding: 0;
        margin: 0;
        font-size: 9pt;
      }
      .section-tablas {
        max-width: 100%;
        margin: 0;
      }
      .tabla-hcc {
        box-shadow: none;
        min-width: 0;
        font-size: 8pt;
      }
      .tabla-hcc th,
      .tabla-hcc td {
        padding: 2px 3px;
        font-size: 8pt;
      }
    }
  </style>
</head>
<body>

  <!-- [SEC-101] LOGIN / PANTALLA DE ACCESO -->
  <div id="lock-screen" class="lock-screen">
    <div class="lock-card">
      <h2>D.I.M.E. - HCC</h2>
      <div class="lock-subtitle">Ingrese la contraseña.</div>
      <input
        id="pwd-input"
        class="lock-input"
        type="password"
        placeholder="Contraseña"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
      />
      <button id="btn-login" class="lock-btn">Entrar</button>
      <div id="pwd-error" class="lock-error"></div>
    </div>
  </div>

  <!-- [SEC-102] APP COMPLETA (SE VE TRAS EL LOGIN) -->
  <div id="app">

    <!-- [SEC-110] ENCABEZADO PRINCIPAL + LOGO -->
<header class="main-header">
  <div class="main-header-logo">
    <img src="logo-hcc.png" alt="Hospital de Clínicas Caracas">
  </div>
  <div class="main-header-titles">
    <h1>D.I.M.E.</h1>
    <p class="subtitulo">
      Directorio Interactivo Médico Especializado · Hospital de Clínicas Caracas
    </p>
  </div>
</header>
    
    <!-- [SEC-120] ACCIONES SUPERIORES (EXPORTAR) -->
    <div class="top-actions">
      <button type="button" id="btn-export-pdf" class="btn-export">Exportar a PDF</button>
    </div>

    <!-- [SEC-130] FILTROS Y CONTROL DE COLUMNAS -->
    <div class="layout-top">
      <!-- Filtros -->
      <div id="filtros" class="panel">
        <div class="panel-title">Filtros</div>
        <div class="panel-body filtros-grid">
          <div class="filtro filtro-busqueda">
            <label for="busqueda">Buscar por nombre o apellido</label>
            <input type="text" id="busqueda" placeholder="Ej: Pérez, Ana, Luis..." />
          </div>

          <!-- Estatus multi selección -->
          <div class="filtro filtro-multi">
            <div class="filtro-title">Estatus</div>
            <div class="filtro-chips" id="chips-estatus"></div>
          </div>

          <div class="filtro">
            <label for="filtro-especialidad">Especialidad</label>
            <select id="filtro-especialidad"></select>
          </div>

          <div class="filtro">
            <label for="filtro-piso">Piso</label>
            <select id="filtro-piso"></select>
          </div>

          <div class="filtro">
            <label for="filtro-tipoacc">Tipo ACC</label>
            <select id="filtro-tipoacc"></select>
          </div>

          <div class="filtro">
            <label for="filtro-correo">Correo</label>
            <select id="filtro-correo">
              <option value="">Todos</option>
              <option value="Con correo corporativo">Con correo corporativo</option>
              <option value="Con correo personal">Con correo personal</option>
              <option value="Solo corporativo">Solo corporativo</option>
              <option value="Solo personal">Solo personal</option>
              <option value="Sin correo">Sin correo</option>
            </select>
          </div>

          <div class="filtro">
            <label for="filtro-celular">Celular</label>
            <select id="filtro-celular">
              <option value="">Todos</option>
              <option value="Con celular">Con celular</option>
              <option value="Sin celular">Sin celular</option>
            </select>
          </div>

          <div class="filtro filtro-botones">
            <button type="button" id="btn-limpiar">Limpiar filtros</button>
          </div>
        </div>
      </div>

      <!-- Control de columnas -->
      <div id="controles_columnas" class="panel">
        <div class="panel-title">Columnas</div>
        <div class="panel-body" id="panel-columnas"></div>
      </div>
    </div>

    <!-- [SEC-140] RESUMEN DE GRUPO FILTRADO -->
    <div class="summary-panel">
      <span id="summary-text">Mostrando miembros actuales.</span>
      &nbsp;
      <a href="#" id="link-contact-group">Contactar a este grupo…</a>
    </div>

    <!-- [SEC-150] TABLAS PRINCIPALES Y ASOCIADOS -->
    <div class="section-tablas">
      <h2>Principales</h2>
      <div id="tabla-principales-container"></div>

      <h2>Asociados</h2>
      <div id="tabla-asociados-container"></div>
    </div>
  </div>

  <!-- [SEC-201] MODAL CONTACTO INDIVIDUAL -->
  <div id="modal-backdrop" class="modal-backdrop">
    <div class="modal modal-mobile">
      <div class="modal-header">
        <span id="modal-title-text">Contacto</span>
        <button type="button" class="btn btn-secondary btn-icon" id="modal-close">✕</button>
      </div>
      <div class="modal-body">
        <div id="modal-contact-links" class="contact-links"></div>

        <div class="modal-section-title">Datos básicos</div>
        <div id="modal-fields-basic" class="modal-field-group"></div>

        <div class="modal-section-title">Datos profesionales</div>
        <div id="modal-fields-pro" class="modal-field-group"></div>

        <div class="modal-section-title">Contacto</div>
        <div id="modal-fields-contact" class="modal-field-group"></div>

        <div class="modal-section-title">Otros</div>
        <div id="modal-fields-other" class="modal-field-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="btn-modal-cancel">Cerrar</button>
        <button type="button" class="btn btn-danger" id="btn-modal-borrar">Borrar</button>
        <button type="button" class="btn btn-primary" id="btn-modal-modificar">Guardar cambios</button>
        <button type="button" class="btn btn-primary" id="btn-modal-new">Agregar nuevo accionista</button>
      </div>
    </div>
  </div>

  <!-- [SEC-202] MODAL NUEVO ACCIONISTA -->
  <div id="modal-new-backdrop" class="modal-backdrop">
    <div class="modal modal-mobile">
      <div class="modal-header">
        <span>Nuevo accionista</span>
        <button type="button" class="btn btn-secondary btn-icon" id="modal-new-close">✕</button>
      </div>
      <div class="modal-body">
        <p class="modal-help-text">
          Complete los datos del nuevo accionista. Se añadirá a la tabla correspondiente en orden alfabético.
        </p>
        <div id="modal-new-fields" class="modal-field-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="btn-modal-new-cancel">Cerrar</button>
        <button type="button" class="btn btn-primary" id="btn-modal-new-save">Guardar nuevo accionista</button>
      </div>
    </div>
  </div>

  <!-- [SEC-203] MODAL DIFUSIÓN / GRUPO FILTRADO -->
  <div id="modal-bulk-backdrop" class="modal-backdrop">
    <div class="modal modal-wide">
      <div class="modal-header">
        <span>Lista de difusión del grupo filtrado</span>
        <button type="button" class="btn btn-secondary btn-icon" id="bulk-close">✕</button>
      </div>
      <div class="modal-body">
        <p class="modal-help-text">
          Aquí tienes los contactos del grupo actualmente visible. Puedes copiar listas de correos o celulares
          y pegar en tu app de correo, SMS o WhatsApp. También puedes escribir el mensaje base abajo.
        </p>
        <div class="bulk-fields">
          <div>
            <div class="bulk-field-label">Correos corporativos:</div>
            <textarea id="bulk-corp"></textarea>
          </div>
          <div>
            <div class="bulk-field-label">Correos personales:</div>
            <textarea id="bulk-pers"></textarea>
          </div>
          <div>
            <div class="bulk-field-label">Celulares (+58...):</div>
            <textarea id="bulk-cel"></textarea>
          </div>
          <div>
            <div class="bulk-field-label">Mensaje sugerido:</div>
            <textarea id="bulk-msg" placeholder="Escribe aquí el mensaje que quieres enviar..."></textarea>
          </div>
        </div>
        <div class="bulk-buttons">
          <button type="button" class="btn btn-secondary" id="bulk-copy-corp">Copiar correos corporativos</button>
          <button type="button" class="btn btn-secondary" id="bulk-copy-pers">Copiar correos personales</button>
          <button type="button" class="btn btn-secondary" id="bulk-copy-cel">Copiar celulares</button>
          <button type="button" class="btn btn-primary" id="bulk-copy-msg">Copiar mensaje</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="bulk-btn-cancel">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- [SEC-301] LÓGICA JS PRINCIPAL -->
  <script>
    // [SEC-302] CONSTANTES DE COLUMNAS Y METADATOS
    const COL_N   = 0;
    const COL_APE = 1;
    const COL_NOM = 2;
    const COL_EST = 3;
    const COL_ESP = 4;
    const COL_ACC = 5;
    const COL_CEL = 6;
    const COL_PISO= 8;
    const COL_CORP=10;
    const COL_PERS=11;

    const STATUS_WEIGHT = { 'ACTIVO': 0, 'INACTIVO': 1, 'FALLECIDO': 2 };

    const HCC_COLUMNS = (window.HCC_META && window.HCC_META.columns) || [];
    const HCC_DATA    = (window.HCC_META && window.HCC_META.data) || [];

    let modalRow = null;
    let modalTableId = null;
    let newRecordTableId = null;

    // columnas visibles por defecto
    const DEFAULT_VISIBLE_COLS = new Set(['N°','APELLIDOS','NOMBRES','ESTATUS','ESPECIALIDAD']);

    // [SEC-303] UTILIDADES GENERALES
    function getCellText(row, colIndex) {
      const cell = row.querySelector('.col-' + colIndex);
      return cell ? cell.textContent.trim() : '';
    }

    function formatCellHTML(col, value) {
      const val = value.trim();
      if (!val) return '';

      if (col === COL_CEL) {
        const digits = val.replace(/\D/g, '');
        if (digits.length >= 10) {
          const href = 'tel:+' + digits;
          return '<a href="' + href + '">' + val + '</a>';
        }
        return val;
      }
      if (col === COL_CORP || col === COL_PERS) {
        if (val.indexOf('@') !== -1) {
          return '<a href="mailto:' + val + '">' + val + '</a>';
        }
      }
      return val;
    }

    function getSelectedValues(selector) {
      const vals = [];
      document.querySelectorAll(selector + ':checked').forEach(chk => {
        vals.push(chk.value.trim());
      });
      return vals;
    }

    // [SEC-304] CONTROLES DE COLUMNAS (CHECKBOX)
    function buildColumnControls() {
      const panel = document.getElementById('panel-columnas');
      panel.innerHTML = '';
      const allCols = ['N°'].concat(HCC_COLUMNS);

      allCols.forEach((colName, idx) => {
        const label = document.createElement('label');
        label.className = 'chk-col';

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'chk-toggle-col';
        input.dataset.col = idx;
        if (DEFAULT_VISIBLE_COLS.has(colName)) input.checked = true;
        else input.checked = false;

        label.appendChild(input);
        label.append(' ' + colName);
        panel.appendChild(label);
      });
    }

    function applyColumnToggles() {
      const checks = document.querySelectorAll('.chk-toggle-col');
      const tables = [document.getElementById('tabla_principales'), document.getElementById('tabla_asociados')];

      checks.forEach(chk => {
        const colIndex = parseInt(chk.dataset.col, 10);
        const show = chk.checked;
        tables.forEach(tbl => {
          if (!tbl) return;
          const cells = tbl.querySelectorAll('.col-' + colIndex);
          cells.forEach(cell => {
            cell.style.display = show ? '' : 'none';
          });
        });
      });
    }

    function setupColumnControls() {
      document.querySelectorAll('.chk-toggle-col').forEach(chk => {
        chk.addEventListener('change', applyColumnToggles);
      });
    }

    // [SEC-305] CONSTRUCCIÓN DE TABLAS
    function buildTable(tableId, containerId, tipoAcc) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';

      const wrapper = document.createElement('div');
      wrapper.className = 'tabla-wrapper';

      const inner = document.createElement('div');
      inner.className = 'tabla-wrapper-inner';

      const table = document.createElement('table');
      table.id = tableId;
      table.className = 'tabla-hcc';

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');

      let thN = document.createElement('th');
      thN.className = 'col-0';
      thN.textContent = 'N°';
      trh.appendChild(thN);

      HCC_COLUMNS.forEach((colName, idx) => {
        const th = document.createElement('th');
        th.className = 'col-' + (idx + 1);
        th.textContent = colName;
        trh.appendChild(th);
      });

      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      HCC_DATA.forEach(rec => {
        const tAcc = (rec['TIPO ACC'] || '').toUpperCase().trim();
        if ((tipoAcc === 'PRINCIPAL' && tAcc !== 'PRINCIPAL') ||
            (tipoAcc === 'ASOCIADO' && tAcc !== 'ASOCIADO')) {
          return;
        }

        const tr = document.createElement('tr');

        const tdN = document.createElement('td');
        tdN.className = 'col-0';
        tdN.textContent = '';
        tr.appendChild(tdN);

        HCC_COLUMNS.forEach((colName, cIdx) => {
          const td = document.createElement('td');
          const colIndex = cIdx + 1;
          td.className = 'col-' + colIndex;
          const rawVal = rec[colName] != null ? String(rec[colName]) : '';
          td.innerHTML = formatCellHTML(colIndex, rawVal);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      inner.appendChild(table);
      wrapper.appendChild(inner);
      container.appendChild(wrapper);
    }

    function buildTablesFromData() {
      buildTable('tabla_principales', 'tabla-principales-container', 'PRINCIPAL');
      buildTable('tabla_asociados',  'tabla-asociados-container',  'ASOCIADO');
    }

    // [SEC-306] OPCIONES DE FILTROS (COMBOS / CHIPS)
    function fillSimpleSelect(id, values) {
      const sel = document.getElementById(id);
      sel.innerHTML = '<option value="">Todos</option>';
      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
    }

    function buildFilterOptionsFromData() {
      const all = HCC_DATA || [];

      const estatusSet = new Set();
      const espSet = new Set();
      const pisoSet = new Set();
      const tipoSet = new Set();

      all.forEach(rec => {
        if (rec['ESTATUS']) estatusSet.add(rec['ESTATUS'].trim());
        if (rec['ESPECIALIDAD']) espSet.add(rec['ESPECIALIDAD'].trim());
        if (rec['PISO']) pisoSet.add(rec['PISO'].trim());
        if (rec['TIPO ACC']) tipoSet.add(rec['TIPO ACC'].trim());
      });

      const chips = document.getElementById('chips-estatus');
      chips.innerHTML = '';
      Array.from(estatusSet).sort().forEach(val => {
        const label = document.createElement('label');
        label.className = 'chip-filter';
        const inp = document.createElement('input');
        inp.type = 'checkbox';
        inp.className = 'flt-estatus';
        inp.value = val;
        label.appendChild(inp);
        label.append(' ' + val);
        chips.appendChild(label);
      });

      fillSimpleSelect('filtro-especialidad', Array.from(espSet).sort());
      fillSimpleSelect('filtro-piso', Array.from(pisoSet).sort());
      fillSimpleSelect('filtro-tipoacc', Array.from(tipoSet).sort());
    }

    // [SEC-307] APLICAR FILTROS
    function applyFilters() {
      const searchValue = document.getElementById('busqueda').value.trim().toLowerCase();
      const estatusSelected = getSelectedValues('.flt-estatus');
      const espValue   = document.getElementById('filtro-especialidad').value.trim();
      const pisoValue  = document.getElementById('filtro-piso').value.trim();
      const tipoAccVal = document.getElementById('filtro-tipoacc').value.trim();
      const correoVal  = document.getElementById('filtro-correo').value.trim();
      const celVal     = document.getElementById('filtro-celular').value.trim();

      const tables = [document.getElementById('tabla_principales'), document.getElementById('tabla_asociados')];

      tables.forEach(tbl => {
        if (!tbl) return;
        const rows = tbl.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const apellidos    = getCellText(row, COL_APE).toLowerCase();
          const nombres      = getCellText(row, COL_NOM).toLowerCase();
          const estatus      = getCellText(row, COL_EST);
          const especialidad = getCellText(row, COL_ESP);
          const tipoAcc      = getCellText(row, COL_ACC);
          const piso         = getCellText(row, COL_PISO);
          const corp         = getCellText(row, COL_CORP);
          const pers         = getCellText(row, COL_PERS);
          const cel          = getCellText(row, COL_CEL);

          let visible = true;

          if (searchValue) {
            if (!apellidos.includes(searchValue) && !nombres.includes(searchValue)) visible = false;
          }

          if (estatusSelected.length > 0 && !estatusSelected.includes(estatus)) visible = false;
          if (espValue && especialidad !== espValue) visible = false;
          if (pisoValue && piso !== pisoValue) visible = false;
          if (tipoAccVal && tipoAcc !== tipoAccVal) visible = false;

          if (correoVal) {
            const hasCorp = !!corp;
            const hasPers = !!pers;
            if (correoVal === 'Con correo corporativo' && !hasCorp) visible = false;
            if (correoVal === 'Con correo personal' && !hasPers) visible = false;
            if (correoVal === 'Solo corporativo' && (!hasCorp || hasPers)) visible = false;
            if (correoVal === 'Solo personal' && (!hasPers || hasCorp)) visible = false;
            if (correoVal === 'Sin correo' && (hasCorp || hasPers)) visible = false;
          }

          if (celVal) {
            const hasCel = !!cel;
            if (celVal === 'Con celular' && !hasCel) visible = false;
            if (celVal === 'Sin celular' && hasCel) visible = false;
          }

          row.style.display = visible ? '' : 'none';
        });
      });

      renumerarTodo();
      updateSummary();
    }

    function setupFilters() {
      document.getElementById('busqueda').addEventListener('input', applyFilters);
      document.getElementById('filtro-especialidad').addEventListener('change', applyFilters);
      document.getElementById('filtro-piso').addEventListener('change', applyFilters);
      document.getElementById('filtro-tipoacc').addEventListener('change', applyFilters);
      document.getElementById('filtro-correo').addEventListener('change', applyFilters);
      document.getElementById('filtro-celular').addEventListener('change', applyFilters);
      document.addEventListener('change', function(e) {
        if (e.target.classList.contains('flt-estatus')) applyFilters();
      });
      document.getElementById('btn-limpiar').addEventListener('click', function() {
        document.getElementById('busqueda').value = '';
        document.getElementById('filtro-especialidad').value = '';
        document.getElementById('filtro-piso').value = '';
        document.getElementById('filtro-tipoacc').value = '';
        document.getElementById('filtro-correo').value = '';
        document.getElementById('filtro-celular').value = '';
        document.querySelectorAll('.flt-estatus').forEach(chk => chk.checked = false);
        applyFilters();
      });
    }

    // [SEC-308] ORDEN Y NUMERACIÓN DINÁMICA
    function renumerarTabla(tableId) {
      const tbl = document.getElementById(tableId);
      if (!tbl) return;
      const rows = tbl.querySelectorAll('tbody tr');
      let n = 1;
      rows.forEach(row => {
        const cell = row.querySelector('.col-0');
        if (!cell) return;
        if (row.style.display === 'none') {
          cell.textContent = '';
        } else {
          cell.textContent = n;
          n++;
        }
      });
    }

    function renumerarTodo() {
      renumerarTabla('tabla_principales');
      renumerarTabla('tabla_asociados');
    }

    function sortTableByApellidoEstatus(tableId) {
      const tbl = document.getElementById(tableId);
      if (!tbl) return;
      const tbody = tbl.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.sort((a, b) => {
        const apeA = getCellText(a, COL_APE).toUpperCase();
        const apeB = getCellText(b, COL_APE).toUpperCase();
        if (apeA < apeB) return -1;
        if (apeA > apeB) return 1;

        const estA = getCellText(a, COL_EST).toUpperCase();
        const estB = getCellText(b, COL_EST).toUpperCase();
        const wA = STATUS_WEIGHT.hasOwnProperty(estA) ? STATUS_WEIGHT[estA] : 99;
        const wB = STATUS_WEIGHT.hasOwnProperty(estB) ? STATUS_WEIGHT[estB] : 99;
        if (wA < wB) return -1;
        if (wA > wB) return 1;

        const nomA = getCellText(a, COL_NOM).toUpperCase();
        const nomB = getCellText(b, COL_NOM).toUpperCase();
        if (nomA < nomB) return -1;
        if (nomA > nomB) return 1;
        return 0;
      });

      rows.forEach(r => tbody.appendChild(r));
    }

    function sortAllTables() {
      sortTableByApellidoEstatus('tabla_principales');
      sortTableByApellidoEstatus('tabla_asociados');
    }

    // [SEC-309] MODAL DE CONTACTO
    function openModalForRow(row, tableId) {
      modalRow = row;
      modalTableId = tableId;
      newRecordTableId = tableId;

      const backdrop = document.getElementById('modal-backdrop');
      const contactLinks = document.getElementById('modal-contact-links');
      const basic = document.getElementById('modal-fields-basic');
      const pro = document.getElementById('modal-fields-pro');
      const contact = document.getElementById('modal-fields-contact');
      const other = document.getElementById('modal-fields-other');

      contactLinks.innerHTML = '';
      basic.innerHTML = '';
      pro.innerHTML = '';
      contact.innerHTML = '';
      other.innerHTML = '';

      const headerCells = row.closest('table').querySelectorAll('thead th');

      const apellidos = getCellText(row, COL_APE);
      const nombres   = getCellText(row, COL_NOM);
      const nombreCompleto = (apellidos + ' ' + nombres).trim();
      document.getElementById('modal-title-text').textContent = nombreCompleto || 'Contacto';

      const tel = getCellText(row, COL_CEL);
      const corp = getCellText(row, COL_CORP);
      const pers = getCellText(row, COL_PERS);

      if (tel) {
        const digits = tel.replace(/\D/g, '');
        if (digits.length >= 10) {
          const href = 'tel:+' + digits;
          const a = document.createElement('a');
          a.href = href;
          a.textContent = 'Llamar';
          contactLinks.appendChild(a);
        }
      }
      if (corp && corp.indexOf('@') !== -1) {
        const a = document.createElement('a');
        a.href = 'mailto:' + corp;
        a.textContent = 'Correo corporativo';
        contactLinks.appendChild(a);
      }
      if (pers && pers.indexOf('@') !== -1) {
        const a = document.createElement('a');
        a.href = 'mailto:' + pers;
        a.textContent = 'Correo personal';
        contactLinks.appendChild(a);
      }

      headerCells.forEach((th, idx) => {
        const label = th.textContent.trim();
        const cell = row.querySelector('.col-' + idx);
        let value = cell ? cell.textContent.trim() : '';

        const disabled = (idx === COL_N) ? 'disabled' : '';

        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'modal-field';
        fieldDiv.innerHTML =
          '<label>' + label + '</label>' +
          '<input type="text" data-col="' + idx + '" value="' +
          value.replace(/"/g, '&quot;') + '" ' + disabled + '>';

        if (idx === COL_N || idx === COL_APE || idx === COL_NOM) {
          basic.appendChild(fieldDiv);
        } else if (idx === COL_ESP || idx === COL_ACC || idx === COL_PISO || idx === COL_EST) {
          pro.appendChild(fieldDiv);
        } else if (idx === COL_CEL || idx === COL_CORP || idx === COL_PERS) {
          contact.appendChild(fieldDiv);
        } else {
          other.appendChild(fieldDiv);
        }
      });

      backdrop.style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal-backdrop').style.display = 'none';
      modalRow = null;
      modalTableId = null;
    }

    function applyModify() {
      if (!modalRow) return;
      if (!confirm('¿Seguro que deseas MODIFICAR este registro?')) return;

      document.querySelectorAll('#modal-backdrop input[data-col]').forEach(input => {
        const col = parseInt(input.dataset.col, 10);
        if (col === COL_N) return;
        const newVal = input.value.trim();
        const cell = modalRow.querySelector('.col-' + col);
        if (!cell) return;
        cell.innerHTML = formatCellHTML(col, newVal);
      });

      sortAllTables();
      applyFilters();
      closeModal();
    }

    function applyDelete() {
      if (!modalRow) return;
      if (!confirm('¿Seguro que deseas BORRAR este registro?')) return;

      modalRow.parentNode.removeChild(modalRow);
      renumerarTodo();
      updateSummary();
      closeModal();
    }

    // [SEC-310] MODAL “NUEVO ACCIONISTA”
    function openNewAccionistaModal() {
      if (!newRecordTableId) return;

      const tbl = document.getElementById(newRecordTableId);
      if (!tbl) return;

      const headerCells = tbl.querySelectorAll('thead th');
      const container = document.getElementById('modal-new-fields');
      container.innerHTML = '';

      headerCells.forEach((th, idx) => {
        if (idx === COL_N) return;
        const label = th.textContent.trim();
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'modal-field';
        fieldDiv.innerHTML =
          '<label>' + label + '</label>' +
          '<input type="text" data-col="' + idx + '" value="">';
        container.appendChild(fieldDiv);
      });

      document.getElementById('modal-new-backdrop').style.display = 'flex';
    }

    function closeNewAccionistaModal() {
      document.getElementById('modal-new-backdrop').style.display = 'none';
    }

    function saveNewAccionista() {
      if (!newRecordTableId) return;
      const tbl = document.getElementById(newRecordTableId);
      if (!tbl) return;

      const tbody = tbl.querySelector('tbody');
      const newRow = document.createElement('tr');

      const tdN = document.createElement('td');
      tdN.className = 'col-' + COL_N;
      tdN.textContent = '';
      newRow.appendChild(tdN);

      document.querySelectorAll('#modal-new-fields input').forEach(input => {
        const col = parseInt(input.dataset.col, 10);
        const td = document.createElement('td');
        td.className = 'col-' + col;
        const val = input.value.trim();
        td.innerHTML = formatCellHTML(col, val);
        newRow.appendChild(td);
      });

      tbody.appendChild(newRow);

      sortAllTables();
      applyFilters();
      closeNewAccionistaModal();
    }

    // [SEC-311] MODAL DIFUSIÓN / COPIAR LISTAS
    function collectVisibleContacts() {
      const principalTbl = document.getElementById('tabla_principales');
      const asociadoTbl  = document.getElementById('tabla_asociados');

      const corporativos = [];
      const personales   = [];
      const celulares    = [];

      function collectFromTable(tbl) {
        if (!tbl) return;
        const rows = tbl.querySelectorAll('tbody tr');
        rows.forEach(row => {
          if (row.style.display === 'none') return;
          const corp = getCellText(row, COL_CORP);
          const pers = getCellText(row, COL_PERS);
          const cel  = getCellText(row, COL_CEL);
          if (corp && !corporativos.includes(corp)) corporativos.push(corp);
          if (pers && !personales.includes(pers)) personales.push(pers);
          if (cel  && !celulares.includes(cel)) celulares.push(cel);
        });
      }

      collectFromTable(principalTbl);
      collectFromTable(asociadoTbl);

      return { corporativos, personales, celulares };
    }

    function copyToClipboard(text) {
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); } catch (e) {}
        document.body.removeChild(ta);
      }
    }

    function openBulkModal() {
      const backdrop = document.getElementById('modal-bulk-backdrop');
      const corpTa   = document.getElementById('bulk-corp');
      const persTa   = document.getElementById('bulk-pers');
      const celTa    = document.getElementById('bulk-cel');
      const msgTa    = document.getElementById('bulk-msg');

      const data = collectVisibleContacts();

      corpTa.value = data.corporativos.join('; ');
      persTa.value = data.personales.join('; ');
      celTa.value  = data.celulares.join(', ');
      msgTa.value  = '';

      backdrop.style.display = 'flex';
    }

    function closeBulkModal() {
      document.getElementById('modal-bulk-backdrop').style.display = 'none';
    }

    function setupBulkModal() {
      const link = document.getElementById('link-contact-group');
      if (link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          openBulkModal();
        });
      }

      document.getElementById('bulk-close').addEventListener('click', closeBulkModal);
      document.getElementById('bulk-btn-cancel').addEventListener('click', closeBulkModal);

      document.getElementById('bulk-copy-corp').addEventListener('click', function() {
        copyToClipboard(document.getElementById('bulk-corp').value);
      });
      document.getElementById('bulk-copy-pers').addEventListener('click', function() {
        copyToClipboard(document.getElementById('bulk-pers').value);
      });
      document.getElementById('bulk-copy-cel').addEventListener('click', function() {
        copyToClipboard(document.getElementById('bulk-cel').value);
      });
      document.getElementById('bulk-copy-msg').addEventListener('click', function() {
        copyToClipboard(document.getElementById('bulk-msg').value);
      });
    }

    // [SEC-312] RESUMEN (CONTADORES Y TOTAL ACCIONISTAS)
    function updateSummary() {
      const principalTbl = document.getElementById('tabla_principales');
      const asociadoTbl  = document.getElementById('tabla_asociados');
      const summaryEl    = document.getElementById('summary-text');
      if (!summaryEl) return;

      function countByStatus(tbl) {
        if (!tbl) return { total:0, ACTIVO:0, INACTIVO:0, FALLECIDO:0 };
        const rows = tbl.querySelectorAll('tbody tr');
        const res = { total:0, ACTIVO:0, INACTIVO:0, FALLECIDO:0 };
        rows.forEach(row => {
          if (row.style.display === 'none') return;
          res.total++;
          const est = getCellText(row, COL_EST).toUpperCase();
          if (res.hasOwnProperty(est)) res[est]++;
        });
        return res;
      }

      const p = countByStatus(principalTbl);
      const a = countByStatus(asociadoTbl);
      const totalAcc = p.total + a.total;

      function buildPart(label, c) {
        if (c.total === 0) return '0 ' + label;
        const parts = [];
        if (c.ACTIVO)    parts.push(c.ACTIVO + ' activos');
        if (c.INACTIVO)  parts.push(c.INACTIVO + ' inactivos');
        if (c.FALLECIDO) parts.push(c.FALLECIDO + ' fallecidos');
        return c.total + ' ' + label + ' (' + parts.join(', ') + ')';
      }

      const txt = 'Mostrando ' + buildPart('principales', p) +
                  ' y ' + buildPart('asociados', a) +
                  '. Total: ' + totalAcc + ' accionistas.';
      summaryEl.textContent = txt;
    }

    // [SEC-313] EVENTOS TABLAS / EXPORT PDF
    function setupRowEditing() {
      ['tabla_principales', 'tabla_asociados'].forEach(id => {
        const tbl = document.getElementById(id);
        if (!tbl) return;
        const tbody = tbl.querySelector('tbody');
        if (!tbody) return;

        tbody.addEventListener('click', function(e) {
          const row = e.target.closest('tr');
          if (!row) return;
          openModalForRow(row, id);
        });
      });

      document.getElementById('modal-close').addEventListener('click', closeModal);
      document.getElementById('btn-modal-cancel').addEventListener('click', closeModal);
      document.getElementById('btn-modal-borrar').addEventListener('click', applyDelete);
      document.getElementById('btn-modal-modificar').addEventListener('click', applyModify);
      document.getElementById('btn-modal-new').addEventListener('click', openNewAccionistaModal);

      document.getElementById('modal-new-close').addEventListener('click', closeNewAccionistaModal);
      document.getElementById('btn-modal-new-cancel').addEventListener('click', closeNewAccionistaModal);
      document.getElementById('btn-modal-new-save').addEventListener('click', saveNewAccionista);
    }

    function setupExportPDF() {
      const btn = document.getElementById('btn-export-pdf');
      if (!btn) return;
      btn.addEventListener('click', function() {
        window.print();
      });
    }

    // [SEC-314] INICIALIZACIÓN COMPLETA TRAS LOGIN
    function initApp() {
      buildColumnControls();
      buildFilterOptionsFromData();
      buildTablesFromData();

      setupColumnControls();
      setupFilters();
      setupRowEditing();
      setupExportPDF();
      setupBulkModal();

      applyColumnToggles();
      sortAllTables();
      applyFilters(); // renumera + resumen
    }

    // [SEC-315] LOGIN Y DESBLOQUEO (PASSWORD: ojodetigre)
    document.addEventListener('DOMContentLoaded', function() {
      const lock = document.getElementById('lock-screen');
      const app  = document.getElementById('app');
      const input = document.getElementById('pwd-input');
      const btn = document.getElementById('btn-login');
      const errorEl = document.getElementById('pwd-error');

      function tryLogin() {
        const val = input.value;
        if (val === 'ojodetigre') {
          lock.style.display = 'none';
          app.style.display = 'block';
          initApp();
        } else {
          errorEl.textContent = 'Contraseña incorrecta.';
          input.select();
        }
      }

      // Enfocamos el campo de password al cargar
      if (input) {
        input.focus();
        setTimeout(() => input.focus(), 150);
      }

      btn.addEventListener('click', tryLogin);
      input.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') tryLogin();
      });
    });
  </script>
</body>
</html>
